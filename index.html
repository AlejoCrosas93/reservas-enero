<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas salidas al servicio</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --bg: #fafafa;
  --text: #222;
  --card: #ffffff;
  --blue: #2f6fb2;
  --green: #4caf50;
  --gray: #777;
}

.dark {
  --bg: #121212;
  --text: #f0f0f0;
  --card: #1e1e1e;
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
  transition: 0.3s;
}

h2, h3 { text-align: center; }

#bienvenida {
  display: none;
  background: var(--card);
  padding: 15px;
  border-radius: 12px;
  margin: 15px 0;
  font-size: 0.95em;
}

input, button {
  width: 100%;
  max-width: 400px;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-family: inherit;
}

button {
  background: var(--blue);
  color: white;
  border: none;
  cursor: pointer;
}

button.bloquear { background: #777; }
button.desbloquear { background: #c0392b; }

.slot {
  background: var(--card);
  border-radius: 14px;
  padding: 15px;
  margin: 12px 0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.06);
}

.slot.mia { border-left: 6px solid var(--blue); }
.slot.libre { border-left: 6px solid var(--green); }
.slot.no-disponible { border-left: 6px solid var(--gray); color: var(--gray); }

.modo {
  position: fixed;
  top: 15px;
  right: 15px;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="modo" onclick="toggleModo()">üåô</div>

<h2>Reservas salidas al servicio ‚Äì Cong. Colina Campestre</h2>
<h3 id="subtitulo"></h3>

<input id="nombre" placeholder="Tu nombre completo">
<input id="email" placeholder="Tu correo electr√≥nico">

<button onclick="cargar()">Cargar salidas</button>

<div id="bienvenida">
üôè <b>Bienvenido amigo</b>, gracias por hacerte disponible para sacar el grupo.<br><br>
Por favor selecciona y reserva el d√≠a y hora que m√°s te convenga.<br><br>
Que Jehov√° recompense tu duro trabajo.<br>
<i>(Rut 2:12)</i>
</div>

<div id="lista"></div>

<script>
/* ===== CONFIG ===== */
const ADMINS = ["alegabo.98@gmail.com"];
const ADMIN_PASSWORD = "1420";

/* ===== SUBT√çTULO ===== */
(() => {
  const m = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const f = new Date();
  subtitulo.textContent = `${m[f.getMonth()]} de ${f.getFullYear()}`;
})();

/* ===== MODO OSCURO ===== */
function toggleModo() {
  document.body.classList.toggle("dark");
  localStorage.modo = document.body.classList.contains("dark") ? "dark" : "light";
}
if (localStorage.modo === "dark") document.body.classList.add("dark");

/* ===== FECHA ===== */
function diaSemana(f) {
  return ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"][new Date(f+"T00:00:00").getDay()];
}

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
  authDomain: "reservas-enero.firebaseapp.com",
  projectId: "reservas-enero",
});
const db = firebase.firestore();
let unsub = null;

/* ===== ESCUCHA ===== */
function escuchar(email, nombre, admin) {
  if (unsub) unsub();
  unsub = db.collection("salidas").onSnapshot(s => render(s, email, nombre, admin));
}

/* ===== RENDER ===== */
function render(snap, email, nombre, admin) {
  lista.innerHTML = "";

  snap.docs
    .map(d => ({id:d.id, ...d.data()}))
    .sort((a,b)=>new Date(a.fecha+"T"+a.hora)-new Date(b.fecha+"T"+b.hora))
    .forEach(d => {

      const esMia = d.ocupada && d.email === email;

      // ‚ùó Usuarios normales NO ven bloqueadas ni ocupadas por otros
      if (!admin && (d.bloqueada || (d.ocupada && !esMia))) return;

      const div = document.createElement("div");

      div.className = d.bloqueada
        ? "slot no-disponible"
        : esMia
          ? "slot mia"
          : "slot libre";

      div.innerHTML = `
        ${admin ? `
          <button class="${d.bloqueada ? "desbloquear" : "bloquear"}">
            ${d.bloqueada ? "Desbloquear" : "Bloquear"}
          </button><br><br>
        ` : ""}

        <b>${diaSemana(d.fecha)} ${d.fecha}</b><br>
        üïò ${d.hora}<br>
        üìç ${d.lugar}<br><br>

        ${
          esMia
            ? "<b>Reservada por ti</b>"
            : !d.bloqueada
              ? "<button class='reservar'>Reservar</button>"
              : "<b>No disponible</b>"
        }
      `;

      /* ===== ADMIN BLOQUEAR ===== */
      if (admin) {
        const btn = div.querySelector(".bloquear, .desbloquear");
        if (btn) {
          btn.onclick = async () => {
            await db.collection("salidas").doc(d.id).update({
              bloqueada: !d.bloqueada
            });
          };
        }
      }

      /* ===== RESERVAR ===== */
      if (!esMia && !d.bloqueada) {
        const btn = div.querySelector(".reservar");
        if (btn) {
          btn.onclick = async () => {
            await db.collection("salidas").doc(d.id).update({
              ocupada:true,
              email,
              reservadoPor:nombre
            });
          };
        }
      }

      lista.appendChild(div);
    });
}

/* ===== CARGAR ===== */
function cargar() {
  if (!nombre.value || !email.value) return alert("Completa los datos");

  const admin = ADMINS.includes(email.value) &&
    prompt("Clave admin:") === ADMIN_PASSWORD;

  nombre.disabled = email.disabled = true;
  bienvenida.style.display = "block";

  escuchar(email.value, nombre.value, admin);
}
</script>
</body>
</html>
