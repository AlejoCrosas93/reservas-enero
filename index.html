<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservas Enero</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }

    .slot { border: 1px solid #ccc; padding: 10px; margin: 6px 0; }
    .slot.mia { background: #e6f7ff; border-color: #1890ff; }
    .slot.libre { background: #f6ffed; border-color: #52c41a; }
    .slot.no-disponible { background: #f0f0f0; border-color: #999; color: #777; }

    button { margin-top: 5px; }
  </style>
</head>
<body>

<h2>Reservas Enero</h2>

<label>Nombre:</label><br>
<input type="text" id="nombre"><br><br>

<label>Email:</label><br>
<input type="email" id="email"><br><br>

<button onclick="cargar()">Cargar salidas</button>

<div id="lista"></div>

<script>
/* ================= ADMIN ================= */
const ADMINS = ["alegabo.98@gmail.com"];
const ADMIN_PASSWORD = "1420";

/* ================= FECHA ================= */
function diaSemana(fechaISO) {
  const dias = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
  return dias[new Date(fechaISO + "T00:00:00").getDay()];
}

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
  authDomain: "reservas-enero.firebaseapp.com",
  projectId: "reservas-enero",
});

const db = firebase.firestore();
let unsubscribe = null;

/* ================= ESCUCHAR ================= */
function escucharSalidas(email, nombre, admin) {
  if (unsubscribe) unsubscribe();

  unsubscribe = db.collection("salidas").onSnapshot(snap => {
    renderizar(snap, email, nombre, admin);
  });
}

/* ================= RENDER ================= */
function renderizar(snapshot, email, nombre, admin) {
  const cont = document.getElementById("lista");
  cont.innerHTML = "";

  const salidas = [];
  snapshot.forEach(doc => salidas.push({ id: doc.id, ...doc.data() }));

  salidas.sort((a,b) =>
    new Date(a.fecha+"T"+a.hora) - new Date(b.fecha+"T"+b.hora)
  );

  salidas.forEach(d => {
    const esMia = d.ocupada && d.email === email;
    const estaLibre = !d.ocupada;

    if (!admin && d.ocupada && !esMia) return;

    const div = document.createElement("div");

    div.className = d.bloqueada
      ? "slot no-disponible"
      : esMia
        ? "slot mia"
        : estaLibre
          ? "slot libre"
          : "slot no-disponible";

    div.innerHTML = `
      ${admin ? `<button class="toggle">${d.bloqueada ? "Desbloquear" : "Bloquear"}</button><br><br>` : ""}
      <b>${diaSemana(d.fecha)} ${d.fecha}</b><br>
      üïò ${d.hora}<br>
      üìç <b>${d.lugar}</b><br><br>

      ${esMia
        ? `<button class="cancelar">Cancelar</button>`
        : estaLibre && !d.bloqueada
          ? `<button class="reservar">Reservar</button>`
          : `<b>No disponible</b>`
      }
    `;

    /* ===== ADMIN BLOQUEAR ===== */
    if (admin) {
      div.querySelector(".toggle").onclick = async () => {
        const ref = db.collection("salidas").doc(d.id);
        const snap = await ref.get();
        await ref.update({ bloqueada: !snap.data().bloqueada });
      };
    }

    /* ===== CANCELAR ===== */
    if (esMia) {
      div.querySelector(".cancelar").onclick = async () => {
        const diff = (new Date(d.fecha) - new Date()) / 36e5;
        if (diff < 48) return alert("No puedes cancelar con menos de 48 horas");

        await db.collection("salidas").doc(d.id).update({
          ocupada: false,
          email: "",
          reservadoPor: ""
        });
      };
    }

    /* ===== RESERVAR ===== */
    if (estaLibre && !d.bloqueada) {
      div.querySelector(".reservar").onclick = async () => {
        const snap = await db.collection("salidas")
          .where("email","==",email)
          .where("ocupada","==",true)
          .get();

        if (snap.size >= 4) return alert("M√°ximo 4 reservas");

        await db.collection("salidas").doc(d.id).update({
          ocupada: true,
          email,
          reservadoPor: nombre
        });
      };
    }

    cont.appendChild(div);
  });
}

/* ================= CARGAR ================= */
const nombreInput = document.getElementById("nombre");
const emailInput = document.getElementById("email");

function cargar() {
  const nombre = nombreInput.value;
  const email = emailInput.value;

  if (!nombre || !email) return alert("Completa los datos");

  let admin = false;
  if (ADMINS.includes(email)) {
    admin = prompt("Clave admin:") === ADMIN_PASSWORD;
  }

  nombreInput.disabled = true;
  emailInput.disabled = true;

  escucharSalidas(email, nombre, admin);
}
</script>

</body>
</html>
