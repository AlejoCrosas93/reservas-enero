<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservas Enero</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .slot { border: 1px solid #ccc; padding: 10px; margin: 6px 0; }
    button { margin-top: 5px; }
  </style>
</head>
<body>

<h2>Reservas Enero</h2>

<label>Nombre:</label><br>
<input type="text" id="nombre" placeholder="Tu nombre completo" /><br><br>

<label>Email:</label><br>
<input type="email" id="email" placeholder="tu@email.com" /><br><br>

<button onclick="cargar()">Cargar salidas</button>

<div id="lista"></div>
 
<script>
  function diaSemana(fechaISO) {
    const dias = ["domingo", "lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado"];
    const fecha = new Date(fechaISO + "T00:00:00");
    return dias[fecha.getDay()];
  }
</script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
    authDomain: "reservas-enero.firebaseapp.com",
    projectId: "reservas-enero",
    storageBucket: "reservas-enero.firebasestorage.app",
    messagingSenderId: "109682365508",
    appId: "1:109682365508:web:716eee5b1538d2f769d811"
  };

  firebase.initializeApp(firebaseConfig);
  window.db = firebase.firestore();

  let unsubscribe = null;

function escucharSalidas(email, nombre) {
  if (unsubscribe) unsubscribe();

  unsubscribe = db.collection("salidas").onSnapshot(snapshot => {
    renderizar(snapshot, email, nombre);
  });
}

function renderizar(snap, email, nombre) {
  const cont = document.getElementById("lista");
  cont.innerHTML = "";

  const salidas = [];

  snap.forEach(doc => {
    salidas.push({ id: doc.id, ...doc.data() });
  });

  salidas.sort((a, b) => {
    const fechaA = new Date(a.fecha + "T" + a.hora);
    const fechaB = new Date(b.fecha + "T" + b.hora);
    return fechaA - fechaB;
  });

  salidas.forEach(d => {
    const esMia = d.email === email && d.ocupada === true;
    if (d.ocupada === true && d.email !== email) return;

    const div = document.createElement("div");
    div.className = "slot";

    div.innerHTML = `
      <b>${diaSemana(d.fecha)} ${d.fecha}</b><br>
      üïò ${d.hora}<br>
      üìç <b>${d.lugar}</b><br>
      <small>${d.direccion}</small><br><br>
      ${esMia
        ? '<button class="cancelar">Cancelar</button>'
        : '<button class="reservar">Reservar</button>'}
    `;

    if (esMia) {
      div.querySelector(".cancelar").onclick = async () => {
        const ahora = new Date();
        const fechaSalida = new Date(d.fecha + "T00:00:00");
        const diffHoras = (fechaSalida - ahora) / (1000 * 60 * 60);

        if (diffHoras < 48) {
          alert("No puedes cancelar con menos de 48 horas de anticipaci√≥n.");
          return;
        }

        await db.collection("salidas").doc(d.id).update({
          ocupada: false,
          reservadoPor: "",
          email: ""
        });
      };
    }

    if (!esMia) {
      div.querySelector(".reservar").onclick = async () => {

        const reservasSnap = await db
          .collection("salidas")
          .where("email", "==", email)
          .where("ocupada", "==", true)
          .get();

        if (reservasSnap.size >= 4) {
          alert("Ya tienes el m√°ximo de 4 salidas permitidas en el mes.");
          return;
        }

        await db.collection("salidas").doc(d.id).update({
          ocupada: true,
          reservadoPor: nombre,
          email: email
        });
      };
    }

    cont.appendChild(div);
  });
}
  
<script>
  function cargar() {
    const nombre = document.getElementById("nombre").value;
    const email = document.getElementById("email").value;

    if (!nombre || !email) {
      alert("Ingresa nombre y email");
      return;
    }

    escucharSalidas(email, nombre);
  }
</script>
</body>
</html>
