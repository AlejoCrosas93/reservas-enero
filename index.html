<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reservas salidas al servicio</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- ğŸ”¥ FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- ğŸ“§ EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
:root {
  --bg:#fafafa; --text:#222; --card:#fff;
  --blue:#2f6fb2; --green:#4caf50; --gray:#777;
}
.dark { --bg:#121212; --text:#f0f0f0; --card:#1e1e1e; }

body {
  font-family:'Poppins',sans-serif;
  background:var(--bg); color:var(--text);
  padding:20px; transition:.3s;
}

h2,h3{text-align:center}

input,button{
  width:100%; padding:14px; margin-bottom:12px;
  border-radius:10px; font-size:16px;
  border:1px solid #ccc;
}

button{
  background:var(--blue); color:#fff;
  font-weight:500; cursor:pointer; border:none;
}

.slot{
  background:var(--card); border-radius:14px;
  padding:16px; margin:12px 0;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}

.slot.mia{border-left:6px solid var(--blue)}
.slot.libre{border-left:6px solid var(--green)}
.slot.no-disponible{border-left:6px solid var(--gray);color:var(--gray)}

.estado{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-size:.85em;
  margin-bottom:8px;
  font-weight:500;
}
.estado.disponible{background:#e8f5e9;color:#2e7d32}
.estado.nodisponible{background:#eee;color:#777}

#bienvenida{
  display:none; background:var(--card);
  padding:15px; border-radius:12px;
  margin:15px 0;
}

.modo{position:fixed;top:15px;right:15px;cursor:pointer}

/* ===== FESTIVO ===== */
.slot.festivo {
  border-left: 6px solid #9c27b0; /* morado */
  background: linear-gradient(135deg, #faf5ff, #ffffff);
}

.badge-festivo {
  display: inline-block;
  background: #9c27b0;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75em;
  font-weight: 600;
  margin-bottom: 6px;
}

/* ===== SALIDA VENCIDA ===== */
.slot.vencida {
  opacity: 0.55;
  filter: grayscale(60%);
  background: #f3f3f3;
}
  
/* ===== SALIDA RESERVADA ===== */
.slot.reservada {
  border-left: 6px solid #ff9800; /* naranja */
  background: linear-gradient(135deg, #fff3e0, #ffffff);
}

/* ===== SALIDA ESPECIAL SUPERINTENDENTE ===== */
.slot.especial {
  border-left: 6px solid #2196f3;
  background: linear-gradient(135deg, #e3f2fd, #ffffff);
}

.badge-especial {
  display:inline-block;
  background:#2196f3;
  color:white;
  padding:4px 10px;
  border-radius:12px;
  font-size:0.75em;
  font-weight:600;
  margin-bottom:6px;
}
  
</style>
</head>

<body>

<div class="modo" onclick="toggleModo()">ğŸŒ™</div>

<h2>Reservas salidas al servicio â€“ Cong. Colina Campestre</h2>
<h3 id="subtitulo"></h3>

<input id="nombre" placeholder="Tu nombre completo">
<input id="email" placeholder="Tu correo electrÃ³nico">

<button onclick="cargar()">Cargar salidas</button>
<!-- ğŸ‘‘ SOLO ADMIN -->
<button id="btnExcel" style="display:none" onclick="descargarExcel()">
ğŸ“¥ Descargar reservas (Excel)
</button>

<a href="https://wa.me/573155298698?text=Hola,%20necesito%20ayuda%20con%20las%20reservas%20de%20salidas"
   target="_blank"
   style="display:block;text-align:center;
          background:#25D366;color:white;
          padding:14px;border-radius:10px;
          text-decoration:none;font-weight:500;
          margin-bottom:15px;">
ğŸ’¬ Â¿Necesitas ayuda? EscrÃ­benos por WhatsApp
</a>

<div id="bienvenida">
ğŸ™ <b>Bienvenido amigo</b>, gracias por hacerte disponible para sacar el grupo.<br><br>
Por favor selecciona y reserva el dÃ­a y hora que mÃ¡s te convenga.<br><br>
Que JehovÃ¡ recompense tu duro trabajo.<br>
<i>(Rut 2:12)</i>
</div>

<div id="lista"></div>

<script>
/* ===== EMAILJS INIT ===== */
emailjs.init("1tklIP8Pmxwxrokd8");

/* ===== CONFIG ===== */
const ADMINS=["alegabo.98@gmail.com"];
const ADMIN_PASSWORD="ACFirebase*25";
let ES_ADMIN=false;

/* ===== SUBTÃTULO ===== */
(()=>{const m=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const f=new Date();subtitulo.textContent=`${m[f.getMonth()]} de ${f.getFullYear()}`})();

/* ===== MODO OSCURO ===== */
function toggleModo(){
  document.body.classList.toggle("dark");
  localStorage.modo=document.body.classList.contains("dark")?"dark":"light";
}
if(localStorage.modo==="dark")document.body.classList.add("dark");

/* ===== FECHA ===== */
const dias=["domingo","lunes","martes","miÃ©rcoles","jueves","viernes","sÃ¡bado"];
const diaSemana=f=>dias[new Date(f+"T00:00:00").getDay()];
  function esSalidaVencida(fecha) {
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0); // quitar hora

  const fSalida = new Date(fecha + "T00:00:00");

  return fSalida < hoy;
}

function hayEspecialEseDia(lista, fecha) {
  return lista.some(s => s.fecha === fecha && s.especial === true);
}

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
  authDomain:"reservas-enero.firebaseapp.com",
  projectId:"reservas-enero"
});
const db=firebase.firestore();

/* ===== GENERADOR AUTOMÃTICO DE SALIDAS MENSUALES ===== */

const MES = 1;   // Febrero = 1  (Enero=0)
const ANIO = 2026;

// ğŸ“ DIRECCIONES Y LUGARES (los mismos que usas actualmente)
const LUGARES = {
  martes: {
    hora: "09:00",
    lugar: "Territorio Principal",
    direccion: "Colina Campestre"
  },
  miercoles1: {
    hora: "09:00",
    lugar: "Territorio Norte",
    direccion: "Colina Campestre"
  },
  miercoles2: {
    hora: "16:00",
    lugar: "Territorio Sur",
    direccion: "Colina Campestre"
  },
  jueves1: {
    hora: "09:00",
    lugar: "Territorio Principal",
    direccion: "Colina Campestre"
  },
  jueves2: {
    hora: "18:00",
    lugar: "Zoom",
    direccion: "",
    zoomLink: "https://zoom.us"
  },
  viernes: {
    hora: "09:00",
    lugar: "Territorio Principal",
    direccion: "Colina Campestre"
  },
  finSemana: {
    hora: "09:30",
    lugar: "Territorio Principal",
    direccion: "Colina Campestre"
  }
};

// âš ï¸ FESTIVOS MANUALES (si hay lunes festivos)
const FESTIVOS = [
  "2026-02-16" // ejemplo: lunes festivo
];

// ===============================

async function generarSalidasMesAutomatico() {

  console.log("ğŸ“… Generando salidas mes:", MES + 1, ANIO);

  const diasMes = new Date(ANIO, MES + 1, 0).getDate();

  for (let dia = 1; dia <= diasMes; dia++) {

    const fechaObj = new Date(ANIO, MES, dia);
    const fechaISO = fechaObj.toISOString().split("T")[0];

    const diaSemana = fechaObj.getDay(); 
    // 0 dom â€” 1 lun â€” 2 mar â€” 3 mie â€” 4 jue â€” 5 vie â€” 6 sab

    const esFestivo = FESTIVOS.includes(fechaISO);

    let salidasHoy = [];

    // ===== REGLAS =====

    // Lunes â†’ solo si festivo
    if (diaSemana === 1 && esFestivo) {
      salidasHoy.push(LUGARES.finSemana);
    }

    // Martes
    if (diaSemana === 2) {
      salidasHoy.push(LUGARES.martes);
    }

    // MiÃ©rcoles (2 salidas)
    if (diaSemana === 3) {
      salidasHoy.push(LUGARES.miercoles1);
      salidasHoy.push(LUGARES.miercoles2);
    }

    // Jueves (territorio + zoom)
    if (diaSemana === 4) {
      salidasHoy.push(LUGARES.jueves1);
      salidasHoy.push(LUGARES.jueves2);
    }

    // Viernes
    if (diaSemana === 5) {
      salidasHoy.push(LUGARES.viernes);
    }

    // SÃ¡bado y Domingo
    if (diaSemana === 6 || diaSemana === 0) {
      salidasHoy.push(LUGARES.finSemana);
    }

    // =============================

    for (const salida of salidasHoy) {

      // âŒ Evitar duplicados
      const existe = await db.collection("salidas")
        .where("fecha", "==", fechaISO)
        .where("hora", "==", salida.hora)
        .get();

      if (!existe.empty) {
        console.log("â­ Ya existe:", fechaISO, salida.hora);
        continue;
      }

      // âœ… Crear salida
      await db.collection("salidas").add({
        fecha: fechaISO,
        hora: salida.hora,
        lugar: salida.lugar,
        direccion: salida.direccion || "",
        zoomLink: salida.zoomLink || "",
        bloqueada: false,
        ocupada: false,
        esFestivo: esFestivo
      });

      console.log("âœ… Creada:", fechaISO, salida.hora, salida.lugar);
    }
  }

  console.log("ğŸ‰ GeneraciÃ³n mensual completada");
}

/* ğŸ” AUTH */
const auth = firebase.auth();
auth.onAuthStateChanged(user => {
  console.log("AUTH USER:", user);
});

// ğŸ” LOGIN ANÃ“NIMO PARA USUARIOS (OBLIGATORIO)
auth.signInAnonymously()
  .then(() => {
    console.log("Usuario anÃ³nimo autenticado");
  })
  .catch(err => {
    console.error("Error auth anÃ³nimo:", err);
  });

function loginAdminSilencioso(email) {
  if (!ADMINS.includes(email)) return;
  auth.signInWithEmailAndPassword(email, ADMIN_PASSWORD)
    .then(() => console.log("Admin autenticado correctamente"))
    .catch(err => console.error("Error login admin:", err.message));
}

let unsub=null;

/* ===== ESCUCHA ===== */
function escuchar(email,nombre){
  if(unsub)unsub();
  unsub=db.collection("salidas").onSnapshot(s=>render(s,email,nombre));
}

/* ===== RENDER ===== */
function render(snap,email,nombre){
  lista.innerHTML="";
  const datos = snap.docs
  .map(d => ({ id: d.id, ...d.data() }))
  .sort((a,b)=> new Date(a.fecha+"T"+a.hora) - new Date(b.fecha+"T"+b.hora));

  datos.forEach(d=>{
    
    const hayEspecial = hayEspecialEseDia(datos, d.fecha);
  // Si hay especial y esta salida NO es especial â†’ ocultar
  if (hayEspecial && !d.especial) return;
    const vencida = esSalidaVencida(d.fecha) && !d.ocupada;
    const esMia = d.ocupada && d.email === email;
    const esReservaAjena = ES_ADMIN && d.ocupada;
    if(!ES_ADMIN && (d.bloqueada || (d.ocupada && !esMia))) return;

    const div = document.createElement("div");

div.className =
  "slot " +
  (d.bloqueada
    ? "no-disponible"
    : d.ocupada
      ? "reservada"
      : esMia
        ? "mia"
        : "libre"
  ) +
  (d.esFestivo ? " festivo" : "") +
  (d.especial ? " especial" : "") +
  (vencida ? " vencida" : "");

    div.innerHTML=`
${d.esFestivo ? "<div class='badge-festivo'>ğŸ‰ DÃ­a festivo</div>" : ""}
${d.especial ? "<div class='badge-especial'>â­ Semana especial â€” Visita SC</div>" : ""}

<span class="estado ${
  vencida
    ? "nodisponible"
    : d.ocupada
      ? "nodisponible"
      : !d.bloqueada
        ? "disponible"
        : "nodisponible"
}">
${vencida
  ? "â° Salida vencida"
  : d.ocupada
    ? "ğŸŸ  Reservada"
    : !d.bloqueada
      ? "ğŸŸ¢ Disponible"
      : "ğŸ”´ No disponible"}
</span>

<b>${diaSemana(d.fecha)} ${d.fecha}</b><br>
ğŸ•˜ ${d.hora}<br>
ğŸ“ <b>${d.lugar}</b><br>

${d.lugar==="Zoom"
?`<a href="${d.zoomLink}" target="_blank">ğŸ’» Entrar a Zoom</a><br><br>`
:`<div>${d.direccion}<br>
<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.direccion)}"
target="_blank">ğŸ“ Ver ubicaciÃ³n en Maps</a></div><br>`}

${d.especial && !ES_ADMIN
  ? "<b>â­ Salida especial â€” Reservada para el Superintendente</b><br><br>"
  : ""
}

${esReservaAjena
  ? `<b>ğŸ‘¤ Reservada por:</b><br>
     ${d.reservadoPor || "Sin nombre"}<br><br>
     <button class='liberar'>ğŸ”“ Liberar (admin)</button>`
  : esMia
    ? "<b>Reservada por ti</b>"
    : d.especial
      ? "<b>â­ Salida especial â€” No reservable</b>"
      : !d.bloqueada
        ? "<button class='reservar'>Reservar</button>"
        : "<b>No disponible</b>"
}

`;

    /* ===== ADMIN: BLOQUEAR / DESBLOQUEAR ===== */
if (ES_ADMIN) {
  if (!d.bloqueada) {
    div.innerHTML += `<button class="bloquear">ğŸš« Bloquear salida</button>`;
  } else {
    div.innerHTML += `<button class="desbloquear">âœ… Desbloquear salida</button>`;
  }
}
    
  /* ===== RESERVAR ===== */
if (!esMia && !d.bloqueada && !d.especial && !vencida && !esReservaAjena) {
  div.querySelector(".reservar")?.addEventListener("click", async () => {
    const ok = confirm(
      `Â¿Confirmas que deseas reservar esta salida?\n\n` +
      `ğŸ“… ${diaSemana(d.fecha)} ${d.fecha}\n` +
      `ğŸ•˜ ${d.hora}\n` +
      `ğŸ“ ${d.lugar}\n\n` +
      `Recuerda que tienes hasta 2 dÃ­as antes para cancelar.`
    );
    if (!ok) return;

    // ğŸš« PROTECCIÃ“N: no permitir reservar salidas especiales
if (d.especial) {
  alert("â­ Esta salida corresponde a la visita del Superintendente y no estÃ¡ disponible para reserva.");
  return;
}

    try {
      // 1ï¸âƒ£ Actualizar salida
      await db.collection("salidas").doc(d.id).update({
        ocupada: true,
        email,
        reservadoPor: nombre
      });

      // 2ï¸âƒ£ Registrar historial
      await db.collection("reservas").add({
        salidaId: d.id,
        fecha: d.fecha,
        hora: d.hora,
        lugar: d.lugar,
        direccion: d.direccion || "",
        reservadoPor: nombre,
        email: email,
        accion: "reservada",
        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
      });

    } catch (err) {
      console.error("Error al reservar:", err);
      alert("âŒ No se pudo guardar la reserva. Revisa tu conexiÃ³n e intÃ©ntalo de nuevo.");
      return; // â›” detener todo
    }

    // 3ï¸âƒ£ Email SOLO si todo saliÃ³ bien
    emailjs.send(
      "service_AlejoCrosas93",
      "template_90uufqn",
      {
        nombre,
        email,
        fecha: `${diaSemana(d.fecha)} ${d.fecha}`,
        hora: d.hora,
        lugar: d.lugar === "Zoom"
          ? "ReuniÃ³n por Zoom"
          : `${d.lugar} â€“ ${d.direccion}`
      }
    ).then(() => {
      alert("âœ… Â¡Reserva realizada con Ã©xito!");
    });
  });
}

   /* ===== ğŸ”“ LIBERAR ===== */
if (esReservaAjena) {
  div.querySelector(".liberar")?.addEventListener("click", async () => {
    const ok = confirm(
      `Â¿Deseas LIBERAR esta salida?\n\n` +
      `ğŸ“… ${diaSemana(d.fecha)} ${d.fecha}\n` +
      `ğŸ•˜ ${d.hora}\n\n` +
      `Esta acciÃ³n es solo para pruebas o errores.`
    );
    if (!ok) return;

    try {
      // 1ï¸âƒ£ Liberar salida
      await db.collection("salidas").doc(d.id).update({
        ocupada: false,
        email: firebase.firestore.FieldValue.delete(),
        reservadoPor: firebase.firestore.FieldValue.delete()
      });

      // 2ï¸âƒ£ Registrar historial
      await db.collection("reservas").add({
        salidaId: d.id,
        fecha: d.fecha,
        hora: d.hora,
        lugar: d.lugar,
        reservadoPor: d.reservadoPor || "",
        email: d.email || "",
        accion: "liberada por admin",
        fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
      });

    } catch (err) {
      console.error("Error al liberar:", err);
      alert("âŒ No se pudo liberar la salida. IntÃ©ntalo nuevamente.");
      return;
    }

    alert("âœ… Salida liberada correctamente");
  });
}

     /* ===== ADMIN: EVENTOS BLOQUEAR / DESBLOQUEAR ===== */
div.querySelector(".bloquear")?.addEventListener("click", async () => {
  const ok = confirm("Â¿Bloquear esta salida para que nadie la pueda reservar?");
  if (!ok) return;

  await db.collection("salidas").doc(d.id).update({
    bloqueada: true
  });

  alert("ğŸš« Salida bloqueada");
});

div.querySelector(".desbloquear")?.addEventListener("click", async () => {
  const ok = confirm("Â¿Desbloquear esta salida para que vuelva a estar disponible?");
  if (!ok) return;

  await db.collection("salidas").doc(d.id).update({
    bloqueada: false
  });

  alert("âœ… Salida desbloqueada");
});
    
    lista.appendChild(div);
  });
}
 
/* ===== CARGAR ===== */
function cargar(){
  if(!nombre.value || !email.value) return alert("Completa los datos");

  ES_ADMIN = ADMINS.includes(email.value)
    && prompt("Clave admin:") === ADMIN_PASSWORD;

  if (ES_ADMIN) loginAdminSilencioso(email.value);
  if (ES_ADMIN) document.getElementById("btnExcel").style.display = "block";

  nombre.disabled = email.disabled = true;
  bienvenida.style.display = "block";
  escuchar(email.value, nombre.value);
  setTimeout(() => bienvenida.scrollIntoView({ behavior: "smooth" }), 300);
}

  /* ===== ADMIN: DESCARGAR EXCEL ===== */
async function descargarExcel() {
  const snap = await db.collection("reservas")
    .orderBy("fechaRegistro", "asc")
    .get();

  if (snap.empty) {
    alert("No hay reservas registradas.");
    return;
  }

  // Encabezados CSV
  let csv = "Fecha,Hora,Lugar,Nombre,Email,AcciÃ³n,Fecha registro\n";

  snap.forEach(doc => {
    const d = doc.data();

    const fecha = d.fecha || "";
    const hora = d.hora || "";
    const lugar = (d.lugar || "").replace(/,/g, " ");
    const nombre = (d.reservadoPor || "").replace(/,/g, " ");
    const email = d.email || "";
    const accion = d.accion || "";

    let fechaRegistro = "";
    if (d.fechaRegistro?.toDate) {
      fechaRegistro = d.fechaRegistro.toDate().toLocaleString();
    }

    csv += `"${fecha}","${hora}","${lugar}","${nombre}","${email}","${accion}","${fechaRegistro}"\n`;
  });

  // Descargar archivo
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "reservas_salidas.csv";
  a.click();

  URL.revokeObjectURL(url);
}

async function generarMesDesdePlantilla(anio, mesDestino) {

  // 1ï¸âƒ£ Leer salidas existentes (plantilla: enero)
  const snap = await db.collection("salidas").get();

  if (snap.empty) {
    alert("No hay salidas base para clonar");
    return;
  }

  const plantilla = [];

  snap.forEach(doc => {
    const d = doc.data();

    // Solo usar salidas vÃ¡lidas
    if (!d.fecha || !d.hora) return;

    plantilla.push(d);
  });

  // 2ï¸âƒ£ Generar fechas del mes destino
  const diasMes = new Date(anio, mesDestino + 1, 0).getDate();

  let creadas = 0;

  for (let dia = 1; dia <= diasMes; dia++) {

    const fechaNueva = new Date(anio, mesDestino, dia);
    const diaSemana = fechaNueva.getDay();

    const fechaStr = fechaNueva.toISOString().slice(0,10);

    // buscar coincidencias de dÃ­a semana + hora
    plantilla.forEach(async base => {

      const baseDay = new Date(base.fecha + "T00:00:00").getDay();

      if (baseDay !== diaSemana) return;

      // 3ï¸âƒ£ evitar duplicados
      const existe = await db.collection("salidas")
        .where("fecha","==",fechaStr)
        .where("hora","==",base.hora)
        .get();

      if (!existe.empty) return;

      // 4ï¸âƒ£ crear nueva salida clonada
      await db.collection("salidas").add({
        fecha: fechaStr,
        hora: base.hora,
        lugar: base.lugar,
        direccion: base.direccion || "",
        zoomLink: base.zoomLink || "",
        ocupada: false,
        bloqueada: false,
        esFestivo: false
      });

      creadas++;
    });

  }

  alert("âœ… Salidas generadas correctamente");
}
  
</script>
</body>
</html>
