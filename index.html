<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reservas salidas al servicio</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- ğŸ”¥ FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- ğŸ“§ EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
:root {
  --bg:#fafafa; --text:#222; --card:#fff;
  --blue:#2f6fb2; --green:#4caf50; --gray:#777;
}
.dark { --bg:#121212; --text:#f0f0f0; --card:#1e1e1e; }

body {
  font-family:'Poppins',sans-serif;
  background:var(--bg); color:var(--text);
  padding:20px; transition:.3s;
}

h2,h3{text-align:center}

input,button{
  width:100%; padding:14px; margin-bottom:12px;
  border-radius:10px; font-size:16px;
  border:1px solid #ccc;
}

button{
  background:var(--blue); color:#fff;
  font-weight:500; cursor:pointer; border:none;
}

.slot{
  background:var(--card); border-radius:14px;
  padding:16px; margin:12px 0;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}

.slot.mia{border-left:6px solid var(--blue)}
.slot.libre{border-left:6px solid var(--green)}
.slot.no-disponible{border-left:6px solid var(--gray);color:var(--gray)}

.estado{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-size:.85em;
  margin-bottom:8px;
  font-weight:500;
}
.estado.disponible{background:#e8f5e9;color:#2e7d32}
.estado.nodisponible{background:#eee;color:#777}

#bienvenida{
  display:none; background:var(--card);
  padding:15px; border-radius:12px;
  margin:15px 0;
}

.modo{position:fixed;top:15px;right:15px;cursor:pointer}
</style>
</head>

<body>

<div class="modo" onclick="toggleModo()">ğŸŒ™</div>

<h2>Reservas salidas al servicio â€“ Cong. Colina Campestre</h2>
<h3 id="subtitulo"></h3>

<input id="nombre" placeholder="Tu nombre completo">
<input id="email" placeholder="Tu correo electrÃ³nico">

<button onclick="cargar()">Cargar salidas</button>

<a href="https://wa.me/573155298698?text=Hola,%20necesito%20ayuda%20con%20las%20reservas%20de%20salidas"
   target="_blank"
   style="display:block;text-align:center;
          background:#25D366;color:white;
          padding:14px;border-radius:10px;
          text-decoration:none;font-weight:500;
          margin-bottom:15px;">
ğŸ’¬ Â¿Necesitas ayuda? EscrÃ­benos por WhatsApp
</a>

<div id="bienvenida">
ğŸ™ <b>Bienvenido amigo</b>, gracias por hacerte disponible para sacar el grupo.<br><br>
Por favor selecciona y reserva el dÃ­a y hora que mÃ¡s te convenga.<br><br>
Que JehovÃ¡ recompense tu duro trabajo.<br>
<i>(Rut 2:12)</i>
</div>

<div id="lista"></div>

<script>
/* ===== EMAILJS INIT ===== */
emailjs.init("1tklIP8Pmxwxrokd8");

/* ===== CONFIG ===== */
const ADMINS=["alegabo.98@gmail.com"];
const ADMIN_PASSWORD="ACFirebase*25";
let ES_ADMIN=false;

/* ===== SUBTÃTULO ===== */
(()=>{const m=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const f=new Date();subtitulo.textContent=`${m[f.getMonth()]} de ${f.getFullYear()}`})();

/* ===== MODO OSCURO ===== */
function toggleModo(){
  document.body.classList.toggle("dark");
  localStorage.modo=document.body.classList.contains("dark")?"dark":"light";
}
if(localStorage.modo==="dark")document.body.classList.add("dark");

/* ===== FECHA ===== */
const dias=["domingo","lunes","martes","miÃ©rcoles","jueves","viernes","sÃ¡bado"];
const diaSemana=f=>dias[new Date(f+"T00:00:00").getDay()];

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
  authDomain:"reservas-enero.firebaseapp.com",
  projectId:"reservas-enero"
});
const db=firebase.firestore();

/* ğŸ” AUTH */
const auth = firebase.auth();
auth.onAuthStateChanged(user => {
  console.log("AUTH USER:", user);
});

function loginAdminSilencioso(email) {
  if (!ADMINS.includes(email)) return;
  auth.signInWithEmailAndPassword(email, ADMIN_PASSWORD)
    .then(() => console.log("Admin autenticado correctamente"))
    .catch(err => console.error("Error login admin:", err.message));
}

let unsub=null;

/* ===== ESCUCHA ===== */
function escuchar(email,nombre){
  if(unsub)unsub();
  unsub=db.collection("salidas").onSnapshot(s=>render(s,email,nombre));
}

/* ===== RENDER ===== */
function render(snap,email,nombre){
  lista.innerHTML="";
  snap.docs.map(d=>({id:d.id,...d.data()}))
  .sort((a,b)=>new Date(a.fecha+"T"+a.hora)-new Date(b.fecha+"T"+b.hora))
  .forEach(d=>{
    const esMia = d.ocupada && d.email === email;
    const esReservaAjena = ES_ADMIN && d.ocupada;
    if(!ES_ADMIN && (d.bloqueada || (d.ocupada && !esMia))) return;

    const div=document.createElement("div");
    div.className=d.bloqueada?"slot no-disponible":esMia?"slot mia":"slot libre";

    div.innerHTML=`
<span class="estado ${!d.bloqueada&&!d.ocupada?"disponible":"nodisponible"}">
${!d.bloqueada&&!d.ocupada?"ğŸŸ¢ Disponible":"ğŸ”´ No disponible"}
</span><br>

<b>${diaSemana(d.fecha)} ${d.fecha}</b><br>
ğŸ•˜ ${d.hora}<br>
ğŸ“ <b>${d.lugar}</b><br>

${d.lugar==="Zoom"
?`<a href="${d.zoomLink}" target="_blank">ğŸ’» Entrar a Zoom</a><br><br>`
:`<div>${d.direccion}<br>
<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.direccion)}"
target="_blank">ğŸ“ Ver ubicaciÃ³n en Maps</a></div><br>`}

${esMia
  ? "<b>Reservada por ti</b>"
  : esReservaAjena
    ? "<button class='liberar'>ğŸ”“ Liberar (admin)</button>"
    : !d.bloqueada
      ? "<button class='reservar'>Reservar</button>"
      : "<b>No disponible</b>"
}
`;

    /* ===== ADMIN: BLOQUEAR / DESBLOQUEAR ===== */
if (ES_ADMIN) {
  if (!d.bloqueada) {
    div.innerHTML += `<button class="bloquear">ğŸš« Bloquear salida</button>`;
  } else {
    div.innerHTML += `<button class="desbloquear">âœ… Desbloquear salida</button>`;
  }
}
    
    /* ===== RESERVAR ===== */
    if(!esMia && !d.bloqueada && !esReservaAjena){
      div.querySelector(".reservar")?.addEventListener("click", async ()=>{
        const ok = confirm(
          `Â¿Confirmas que deseas reservar esta salida?\n\n` +
          `ğŸ“… ${diaSemana(d.fecha)} ${d.fecha}\n` +
          `ğŸ•˜ ${d.hora}\n` +
          `ğŸ“ ${d.lugar}\n\n` +
          `Recuerda que tienes hasta 2 dÃ­as antes para cancelar.`
        );
        if(!ok) return;

        await db.collection("salidas").doc(d.id)
          .update({ocupada:true,email,reservadoPor:nombre});

        emailjs.send(
          "service_AlejoCrosas93",
          "template_90uufqn",
          {
            nombre,email,
            fecha:`${diaSemana(d.fecha)} ${d.fecha}`,
            hora:d.hora,
            lugar:d.lugar==="Zoom"?"ReuniÃ³n por Zoom":`${d.lugar} â€“ ${d.direccion}`
          }
        ).then(()=>{
          alert("âœ… Â¡Reserva realizada con Ã©xito!");
        });
      });
    }

    /* ===== ğŸ”“ LIBERAR (PASO 3.2) ===== */
    if (esReservaAjena) {
      div.querySelector(".liberar")?.addEventListener("click", async () => {
        const ok = confirm(
          `Â¿Deseas LIBERAR esta salida?\n\n` +
          `ğŸ“… ${diaSemana(d.fecha)} ${d.fecha}\n` +
          `ğŸ•˜ ${d.hora}\n\n` +
          `Esta acciÃ³n es solo para pruebas o errores.`
        );
        if (!ok) return;

        await db.collection("salidas").doc(d.id).update({
          ocupada: false,
          email: firebase.firestore.FieldValue.delete(),
          reservadoPor: firebase.firestore.FieldValue.delete()
        });

        alert("âœ… Salida liberada correctamente");
      });
    }

     /* ===== ADMIN: EVENTOS BLOQUEAR / DESBLOQUEAR ===== */
div.querySelector(".bloquear")?.addEventListener("click", async () => {
  const ok = confirm("Â¿Bloquear esta salida para que nadie la pueda reservar?");
  if (!ok) return;

  await db.collection("salidas").doc(d.id).update({
    bloqueada: true
  });

  alert("ğŸš« Salida bloqueada");
});

div.querySelector(".desbloquear")?.addEventListener("click", async () => {
  const ok = confirm("Â¿Desbloquear esta salida para que vuelva a estar disponible?");
  if (!ok) return;

  await db.collection("salidas").doc(d.id).update({
    bloqueada: false
  });

  alert("âœ… Salida desbloqueada");
});
    
    lista.appendChild(div);
  });
}
 
/* ===== CARGAR ===== */
function cargar(){
  if(!nombre.value || !email.value) return alert("Completa los datos");

  ES_ADMIN = ADMINS.includes(email.value)
    && prompt("Clave admin:") === ADMIN_PASSWORD;

  if (ES_ADMIN) loginAdminSilencioso(email.value);

  nombre.disabled = email.disabled = true;
  bienvenida.style.display = "block";
  escuchar(email.value, nombre.value);
  setTimeout(() => bienvenida.scrollIntoView({ behavior: "smooth" }), 300);
}
</script>
</body>
</html>
