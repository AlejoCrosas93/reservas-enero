<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reservas salidas al servicio</title>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- üî• FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- üìß EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
:root {
  --bg:#fafafa; --text:#222; --card:#fff;
  --blue:#2f6fb2; --green:#4caf50; --gray:#777;
}
.dark { --bg:#121212; --text:#f0f0f0; --card:#1e1e1e; }

body {
  font-family:'Poppins',sans-serif;
  background:var(--bg); color:var(--text);
  padding:20px; transition:.3s;
}

h2,h3{text-align:center}

input,button{
  width:100%; padding:14px; margin-bottom:12px;
  border-radius:10px; font-size:16px;
  border:1px solid #ccc;
}

button{
  background:var(--blue); color:#fff;
  font-weight:500; cursor:pointer; border:none;
}

.slot{
  background:var(--card); border-radius:14px;
  padding:16px; margin:12px 0;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}

.slot.mia{border-left:6px solid var(--blue)}
.slot.libre{border-left:6px solid var(--green)}
.slot.no-disponible{border-left:6px solid var(--gray);color:var(--gray)}

.estado{
  display:inline-block;
  padding:6px 14px;
  border-radius:20px;
  font-size:.85em;
  margin-bottom:8px;
  font-weight:500;
}
.estado.disponible{background:#e8f5e9;color:#2e7d32}
.estado.nodisponible{background:#eee;color:#777}

#bienvenida{
  display:none; background:var(--card);
  padding:15px; border-radius:12px;
  margin:15px 0;
}

.modo{position:fixed;top:15px;right:15px;cursor:pointer}
</style>
</head>

<body>

<div class="modo" onclick="toggleModo()">üåô</div>

<h2>Reservas salidas al servicio ‚Äì Cong. Colina Campestre</h2>
<h3 id="subtitulo"></h3>

<input id="nombre" placeholder="Tu nombre completo">
<input id="email" placeholder="Tu correo electr√≥nico">

<button onclick="cargar()">Cargar salidas</button>

<div id="bienvenida">
üôè <b>Bienvenido amigo</b>, gracias por hacerte disponible para sacar el grupo.<br><br>
</div>

<div id="lista"></div>

<script>
/* ===== EMAILJS INIT ===== */
emailjs.init("1tklIP8Pmxwxrokd8");

/* ===== CONFIG ===== */
const ADMINS=["alegabo.98@gmail.com"];
const ADMIN_PASSWORD="ACFirebase*25";
let ES_ADMIN=false;
let APP_INICIADA=false; // ‚úÖ NUEVO

/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey:"AIzaSyATPtS-ZstYA1llON7Dc73y0stjGc0o1Ng",
  authDomain:"reservas-enero.firebaseapp.com",
  projectId:"reservas-enero"
});
const db=firebase.firestore();

/* üîê AUTH */
const auth = firebase.auth();
auth.onAuthStateChanged(user => {
  console.log("AUTH USER:", user);

  if (user && ADMINS.includes(user.email)) {
    ES_ADMIN = true;

    // ‚úÖ SOLO re-renderizar si el usuario ya inici√≥ el flujo
    if (APP_INICIADA) {
      if (unsub) unsub();
      escuchar(email.value, nombre.value);
    }
  }
});

function loginAdminSilencioso(email) {
  if (!ADMINS.includes(email)) return;

  auth.signInWithEmailAndPassword(email, ADMIN_PASSWORD)
    .then(() => console.log("Admin autenticado correctamente"))
    .catch(err => console.error("Error login admin:", err.message));
}

let unsub=null;

/* ===== ESCUCHA ===== */
function escuchar(email,nombre){
  if(unsub)unsub();
  unsub=db.collection("salidas").onSnapshot(s=>render(s,email,nombre));
}

/* ===== RENDER ===== */
function render(snap,email,nombre){
  lista.innerHTML="";
  snap.docs.map(d=>({id:d.id,...d.data()}))
  .sort((a,b)=>new Date(a.fecha+"T"+a.hora)-new Date(b.fecha+"T"+b.hora))
  .forEach(d=>{
    const esMia = d.ocupada && d.email === email;
    const esReservaAjena = ES_ADMIN && d.ocupada && !esMia;

    if (d.bloqueada && !ES_ADMIN) return;
    if (d.ocupada && !esMia && !ES_ADMIN) return;

    const div=document.createElement("div");
    div.className=d.bloqueada?"slot no-disponible":esMia?"slot mia":"slot libre";

    div.innerHTML=`
<b>${d.fecha} ‚Äì ${d.hora}</b><br>
${esMia
  ? "<b>Reservada por ti</b>"
  : esReservaAjena
    ? "<button class='liberar'>üîì Liberar (admin)</button>"
    : !d.bloqueada
      ? "<button class='reservar'>Reservar</button>"
      : "<b>No disponible</b>"
}
`;

    if (esReservaAjena) {
      div.querySelector(".liberar")?.addEventListener("click", async () => {
        if (!confirm("¬øLiberar esta salida?")) return;
        await db.collection("salidas").doc(d.id).update({
          ocupada:false,
          email:firebase.firestore.FieldValue.delete(),
          reservadoPor:firebase.firestore.FieldValue.delete()
        });
        alert("Salida liberada");
      });
    }

    lista.appendChild(div);
  });
}

/* ===== CARGAR ===== */
function cargar(){
  if(!nombre.value || !email.value) return alert("Completa los datos");

  APP_INICIADA = true; // ‚úÖ NUEVO

  ES_ADMIN = ADMINS.includes(email.value)
    && prompt("Clave admin:") === ADMIN_PASSWORD;

  if (ES_ADMIN) loginAdminSilencioso(email.value);

  nombre.disabled = email.disabled = true;
  bienvenida.style.display = "block";
  escuchar(email.value, nombre.value);
}
</script>
</body>
</html>
